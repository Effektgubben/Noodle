<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <link rel="stylesheet" href="Assets/reset.css">
    <link rel="stylesheet" href="Assets/style.css">
    <link rel="stylesheet" href="Assets/nodeTransform.css">
    <link rel="stylesheet" href="Assets/ports.css">
    <link rel="stylesheet" href="Assets/menus.css">
    <link rel="stylesheet" href="Assets/input.css">



    <!-- import external stuff -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway:300' rel='stylesheet' type='text/css'>

    <!-- Local scripts -->
    <script src="Scripts/NoodleObject/noodle.js"></script>

    <script src="Scripts/NoodleObject/Types/Node.js"></script>
    <script src="Scripts/NoodleObject/Types/Port.js"></script>
    <script src="Scripts/NoodleObject/Types/Wire.js"></script>
    <script src="Scripts/NoodleObject/Types/Expr.js"></script>
    <script src="Scripts/NoodleObject/Types/Obj.js"></script>
    <script src="Scripts/NoodleObject/Types/Array.js"></script>
    <script src="Scripts/NoodleObject/Types/String.js"></script>
    <script src="Scripts/NoodleObject/Types/SortedList.js"></script>

    <script src="Scripts/NoodleObject/graphics.js"></script>
    <script src="Scripts/NoodleObject/ui.js"></script>
    <script src="Scripts/NoodleObject/hotkeys.js"></script>
    <script src="Scripts/NoodleObject/ids.js"></script>
    <script src="Scripts/NoodleObject/html.js"></script>

    <script src="Scripts/NoodleObject/thread.js"></script>

    <script src="Scripts/NoodleObject/misc.js"></script>

    <script src="Scripts/NoodleObject/global.js"></script>
    <script src="Scripts/NoodleObject/events.js"></script>


    <script src="Scripts/htmlElements.js"></script>

    <script src="Scripts/input.js"></script>

    <script src="Scripts/coodle.js"></script>

</head>

<body>
    <div class="mainContainer" id="mainCont0">
        <svg id="wireBoard0" width="100%"></svg>
        <div id="nodeCanvas"></div>

        <a class="hoverSelect">Slack: </a>
        <input type="number" value="5" onchange="updateWireStyle()" id="slack" class="hoverSelect">
        <a class="hoverSelect">Handle length: </a>
        <input type="number" value="0.5" onchange="updateWireStyle()" id="hanLen" class="hoverSelect">

        <div class="dataBox textDb" id="db0">
            <input type="text" class="textDbInput"> </div>
        <button onclick="go()">Run JS</button>
    </div>


    <script>
        //{
        var mainCont = document.getElementById("mainCont0");
        var nodeBoard = document.getElementById("nodeCanvas");
        var wireBoard = document.getElementById("wireBoard0"); //TODO: wireBoard should be auto generated
        var container = {
            html: mainCont
        };


        //nodeCanv(document.getElementById("nodeCanvas"));
        /*{

        var simp = {c: []};
        simp.c.push(simp);
        var sClone = noodle.obj.clonePlus(noodle, simp, {}, {})



        var obj = {
            a: 3, b: [1, [1, 2, "apa"], { p: 1, q: 'a' }], c: { x: 1, y: [7, 5], z: "apa" }
        };
        obj.d = obj;
        obj.b[2].r = obj;

        var flat = noodle.obj.flatList(noodle, obj);

        var clone = noodle.obj.clone(noodle, obj);

        var obj1 = {a: 3};
        obj1.b = obj1;

        var clone1 = noodle.obj.clone(noodle, obj1);


        var map = {};

        noodle.obj.clonePlus(noodle, obj, {}, map);

        var gClone = noodle.obj.guidedClone(noodle, map);

        //}*/



        var coreList = [

            noodle.node.newExpr(
                noodle, //noodle
                'Add', //name
                function (node) {
                    node.core.outPorts[0].value = node.core.inPorts[0].value + node.core.inPorts[0].value;
                }, //func
                [
                    noodle.port.new(noodle, 'term0', 'num', true),
                    noodle.port.new(noodle, 'term1', 'num', true)
                ], //inPortExps
                [
                    noodle.port.new(noodle, 'sum', 'num', false)
                ], //outPortExps
                {}, //data
                [], //resetFuncs
                'yellow' //color
            ),

            noodle.node.newExpr(
                noodle, //noodle
                'Value', //name
                function (node) {
                    node.core.outPorts[0].value = 3;
                }, //func
                [], //inPortExps
                [
                    noodle.port.new(noodle, 'value', 'num', false)
                ], //outPortExps
                {}, //data
                [], //resetFuncs
                'blue', //color
                noodle.files.getFile('Html/valueNode.html') //htmlContent
            ),

            noodle.node.newExpr(
                noodle, //noodle
                'Text', //name
                function (node) {
                    var core = node.core;
                    //core.data.text = core.inPorts[0].value;
                    core.outPorts[0].value = core.data.text;
                }, //func
                [], //inPortExps
                [
                    noodle.port.new(noodle, 'value', 'text', false)
                ], //outPortExps
                {
                    text: "",
                    updateOutPort(core) {
                        core.outPorts[0].value = core.data.text;
                    }
                }, //data
                [
                    function () {
                        $('.textDbInput').change(defTextDbInputChange);
                    }
                ], //resetFuncs
                'grey', //color
                '<input type="text" class="textDbInput">'
            ),

            noodle.node.newExpr(
                noodle, //noodle
                'Eval', //name
                function (node) {
                    var core = node.core;
                    eval(core.inPorts[0].value);
                }, //func
                [
                    noodle.port.new(noodle, 'code', 'string', true),
                ], //inPortExps
                [], //outPortExps
                {
                    code: ''
                }, //data
                [], //resetFuncs
                'green' //color
            ),

            noodle.node.newExpr(
                noodle, //noodle
                'BrowserCode', //name
                function (node) {
                    var core = node.core;
                }, //func
                [], //inPortExps
                [
                    noodle.port.new(noodle, 'function', 'function', false)
                ], //outPortExps
                {
                    code: null
                }, //data
                [
                    function (node) {
                        noodle.html.firstByClass(node.html, 'btn').onclick = function () {
                            var nodeEl = noodle.html.getParentNodeEl(this);
                            var node = noodle.node.getObj(noodle, nodeEl);

                            node.core.data.code = noodle.userFunc;
                        }
                    }
                ], //resetFuncs
                'Grey', //color
                '<button class="btn">Get code</button>'
            ),

            noodle.node.newExpr(
                noodle, //noodle
                'Dummy', //name
                function (node) {
                    var core = node.core;
                    if (core.inPorts[core.inPorts.length - 1].wires.length != 0) { //If last port is connected
                        noodle.port.addToPorts(node, core.inPorts, noodle.port.new(noodle, 'in', 'text', true));
                    }
                    if (core.outPorts[core.outPorts.length - 1].wires.length != 0) {
                        noodle.port.addToPorts(node, core.outPorts, noodle.port.new(noodle, 'out', 'text', false));
                    }
                }, //func
                [
                    noodle.port.new(noodle, 'in', 'text', true)
                ], //inPortExps
                [
                    noodle.port.new(noodle, 'out', 'text', false)
                ], //outPortExps
                {}, //data
                [
                    function (node) {
                        node.core.func(node);
                    }
                ], //resetFuncs
                'White', //color
                '<input type="text" class="textDbInput" style="width: 100%">'
            )
        ];
        var nodeTypes = {
            //Add(...){...} doesn't work since it's a constructor
            Add: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'add',
                    color: 'yellow',
                    inPorts: [
                        noodle.port.new(noodle, 'term0', 'num', true),
                        noodle.port.new(noodle, 'term1', 'num', true)
                    ],
                    outPorts: [
                        noodle.port.new(noodle, 'sum', 'num', false)
                    ],
                    func: function (node) {
                        node.core.outPorts[0].value = node.core.inPorts[0].value + node.core.inPorts[0].value;
                    },
                    data: {},
                    resetFuncs: [],
                    htmlContent: ''
                };
                //TODO: Check if this is window?
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
            Value: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'Value',
                    color: 'blue',
                    inPorts: [
                    ],
                    outPorts: [
                        noodle.port.new(noodle, 'value', 'num', false)
                    ],
                    func: function (node) {
                        node.core.outPorts[0].value = 3;
                    },
                    data: {},
                    resetFuncs: [],
                    htmlContent: noodle.files.getFile('Html/valueNode.html')
                };
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
            Text: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'Text',
                    color: 'grey',
                    inPorts: [
                    ],
                    outPorts: [
                        noodle.port.new(noodle, 'value', 'text', false)
                    ],
                    func: function (node) {
                        var core = node.core;
                        //core.data.text = core.inPorts[0].value;
                        core.outPorts[0].value = core.data.text;
                    },
                    data: {
                        text: "",
                        updateOutPort(core) {
                            core.outPorts[0].value = core.data.text;
                        }
                    },
                    resetFuncs: [
                        function () {
                            $('.textDbInput').change(defTextDbInputChange);
                        }
                    ],
                    htmlContent: '<input type="text" class="textDbInput">'
                };
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
            Eval: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'Eval',
                    color: 'green',
                    inPorts: [
                        noodle.port.new(noodle, 'code', 'string', true),
                    ],
                    outPorts: [
                    ],
                    func: function (node) {
                        var core = node.core;
                        //core.data.text = core.inPorts[0].value;
                        core.outPorts[0].value = core.data.text;
                    },
                    data: {
                        text: '',
                    },
                    resetFuncs: [
                    ],
                    htmlContent: ''
                };
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
            BrowserCode: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'BrowserCode',
                    color: 'Grey',
                    inPorts: [
                    ],
                    outPorts: [
                        noodle.port.new(noodle, 'function', 'function', false)
                    ],
                    func: function (node) {
                        var core = node.core;
                    },
                    data: {
                        code: null,
                    },
                    resetFuncs: [
                        function (node) {
                            noodle.html.firstByClass(node.html, 'btn').onclick = function () {
                                var nodeEl = noodle.html.getParentNodeEl(this);
                                var node = noodle.node.getObj(noodle, nodeEl);

                                node.core.data.code = noodle.userFunc;
                            }
                        }
                    ],
                    htmlContent: ''
                };
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
            Dummy: function (noodle, label, pos, noodleExp) {
                var core = {
                    name: 'Dummy',
                    color: 'white',
                    inPorts: [
                        noodle.port.new(noodle, 'in', 'text', true)
                    ],
                    outPorts: [
                        noodle.port.new(noodle, 'out', 'text', false)
                    ],
                    func: function (node) {
                        var core = node.core;
                        if (core.inPorts[core.inPorts.length - 1].wires.length != 0) { //If last port is connected
                            noodle.port.addToPorts(node, core.inPorts, noodle.port.new(noodle, 'in', 'text', true));
                        }
                        if (core.outPorts[core.outPorts.length - 1].wires.length != 0) {
                            noodle.port.addToPorts(node, core.outPorts, noodle.port.new(noodle, 'out', 'text', false));
                        }
                    },
                    data: {
                    },
                    resetFuncs: [
                        function (node) {
                            node.core.func(node);
                        }
                    ],
                    htmlContent: '<input type="text" class="textDbInput" style="width: 100%">'
                };
                var node = noodle.node.new(noodle, core, label, pos);
                for (var i in node) {
                    this[i] = node[i];
                }
            },
        }
        container.wires = [];
        go();
        function go() {

            var startTime = 0;
            var calcTime = 0;
            startTime = new Date().getTime();
            container.forest = [];
            //noodle.node.add(noodle, coreObj.Value, '', {x: 0, y: 0}),
            noodle.node.add(noodle, nodeTypes.Add, '', { x: 500, y: 0 });
            noodle.node.add(noodle, nodeTypes.Value, '', { x: 40, y: 200 });
            noodle.node.add(noodle, nodeTypes.Dummy, '', { x: 100, y: 500 });

            calcTime = new Date().getTime() - startTime;
            console.log('Render time: ' + calcTime);
            noodle.port.connect(container.forest[1].core.outPorts[0], container.forest[0].core.inPorts[0]);
        }




        /*
        container.forest[0].core.outPorts = [{wires: [wires[0]], value: 3}];

        container.forest[1].core.inPorts = [{name: "Term", wires: [wires[0]], value: 0}, {name: "Term", wires: [], value: 1}];
        container.forest[1].core.outPorts = [{name: "Sum", wires: [], value: 0}];


        wires[0].node0 = container.forest[0];
        wires[0].port0 = container.forest[0].core.outPorts[0];
        wires[0].node1 = container.forest[1];
        wires[0].port1 = container.forest[1].core.inPorts[0];


        setNodeHtml(container.forest[0]);
        renderNode(container.forest[0], nodeBoard);

        setNodeHtml(container.forest[1]);
        renderNode(container.forest[1], nodeBoard);




        add2IdForest(container.forest[0]);
        add2IdForest(container.forest[1]);



        renderWire(wires[0]);
        */


        function updateWireStyle() {
            noodle.wire.slack = document.getElementById("slack").value;
            noodle.wire.hanLen = document.getElementById("hanLen").value;
            noodle.wire.update(container.wires[0]);
        }

    </script>


</body>

</html>